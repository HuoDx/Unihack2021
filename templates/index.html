<!DOCTYPE html>

<head>
    <meta charset="UTF-8">
    <title>活点地图</title>
    <link rel="shortcut icon" href="/static/favicon.ico">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <meta name="Description" content="活点地图 - 实时显示附近的资源">
    <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/css/mdui.min.css"
        integrity="sha384-cLRrMq39HOZdvE0j6yBojO4+1PrHfB7a9l5qLcmRm/fiWXYY+CndJPmyu5FV/9Tw" crossorigin="anonymous" />
    <style type="text/css">
        html {
            height: 100%
        }

        body {
            height: 100%;
            margin: 0px;
            padding: 0px
        }

        #map-view {
            height: 100%
        }
    </style>
    <!-- Baidu lbsyun -->
    <script type="text/javascript" src="https://api.map.baidu.com/api?type=webgl&v=1.0&ak={{access_key}}"></script>
    <script type="text/javascript" src="https://api.map.baidu.com/api?v=3.0&ak={{access_key}}"></script>
    <!-- MDUI -->
    <script src="https://cdn.jsdelivr.net/npm/mdui@1.0.1/dist/js/mdui.min.js"
        integrity="sha384-gCMZcshYKOGRX9r6wbDrvF+TcCCswSHFucUzUPwka+Gr+uHgjlYvkABr95TCOz3A"
        crossorigin="anonymous"></script>
</head>

<body>
    <div id="map-view"></div>
    <div id="info-window-box" style="display: none;">
        <div class="mdui-container mdui-typo">
            <div class="mdui-typo-body">一些信息</div>
            <button class="mdui-btn mdui-btn-raised" style="background-color: rgb(0, 0, 0); color: white;">点击查看</button>
        </div>
    </div>
    <script>
        var $ = (selector) => document.querySelector(selector)
        var geolocation = new BMap.Geolocation();
        async function locate() {
            return new Promise((resolve, reject) => {
                geolocation.getCurrentPosition(
                    function (r) {
                        if (this.getStatus() == BMAP_STATUS_SUCCESS) {
                            console.log('您的位置：' + r.point.lng + ',' + r.point.lat);
                            resolve(r)
                        }
                        else {
                            let errorMessage = this.getStatus()
                            console.error('failed' + errorMessage)
                            reject(errorMessage)
                        }
                    }
                )
            })
        }
        (async () => {
            var map = new BMap.Map('map-view');

            var location = await locate()
            map.enableScrollWheelZoom(true);
            map.centerAndZoom(location.point, 20);
            var mk = new BMap.Marker(location.point);
            var opts = {
                width: 400,     // 信息窗口宽度
                height: 600,    // 信息窗口高度
                title: "Hello"  // 信息窗口标题

            }
            var infoWindow = new BMap.InfoWindow($('#info-window-box').innerHTML, opts);  // 创建信息窗口对象

            map.addOverlay(mk);
            mk.addEventListener("click", function () {
                map.openInfoWindow(infoWindow, location.point);
            });

            var walking = new BMap.WalkingRoute(map, {
                renderOptions: { map: map, autoViewport: true },
                onSearchComplete: function (results) {
                    if (walking.getStatus() != BMAP_STATUS_SUCCESS) {
                        console.error(walking.getStatus())
                        return;
                    }
                    var plan = results.getPlan(0);
                    var output = ''
                    output += `总时长：${plan.getDuration(true)} \n`;  //获取时间
                    output += `总路程：${plan.getDistance(true)} \n`;  //获取距离
                    console.log(output)
                }
            });

            var end = new BMap.Point(location.point.lng+0.008, location.point.lat+0.005);

            walking.search(location.point, end); // 算路
            var p = new BMap.Circle(end, 24, {
                strokeOpacity: 0,
                strokeWeight: 0,
                fillOpacity: 1,
                fillColor: 'green',

            })
            p.addEventListener('click', function(){
                alert('Click')
            })
            map.addOverlay(p)

        })()



    </script>
</body>